<!doctype html>

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OTP Code</title>
  <style>
    html,body{margin:0;padding:0;height:100%;background:#0f172a;color:#e6eef8;display:flex;align-items:center;justify-content:center;font-family:system-ui, sans-serif;user-select:none;cursor:pointer}
    #code{font-family:monospace;font-size:48px;letter-spacing:6px}
    #msg{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:8px 16px;border-radius:8px;font-size:14px;opacity:0;transition:opacity .3s}
    #msg.show{opacity:1}
  </style>
</head>
<body>
  <div id="code">------</div>
  <div id="msg">Copiado!</div>  <script>
    // === Base32 decoder ===
    function base32ToBytes(base32){
      const alphabet='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      base32=base32.toUpperCase().replace(/=+$/,'').replace(/[^A-Z2-7]/g,'');
      const bits=[];for(let c of base32){const v=alphabet.indexOf(c);for(let j=4;j>=0;j--)bits.push((v>>j)&1);}
      const bytes=[];for(let i=0;i+8<=bits.length;i+=8){let b=0;for(let j=0;j<8;j++)b=(b<<1)|bits[i+j];bytes.push(b);}return new Uint8Array(bytes);
    }

    async function hmacSha1(key,msg){
      const cryptoKey=await crypto.subtle.importKey('raw',key,{name:'HMAC',hash:'SHA-1'},false,['sign']);
      const sig=await crypto.subtle.sign('HMAC',cryptoKey,msg);
      return new Uint8Array(sig);
    }

    async function totp(secret,period=30,digits=6){
      const key=base32ToBytes(secret);
      const counter=Math.floor(Date.now()/1000/period);
      const buf=new ArrayBuffer(8);const view=new DataView(buf);
      view.setUint32(0,Math.floor(counter/0x100000000));
      view.setUint32(4,counter>>>0);
      const hmac=await hmacSha1(key,new Uint8Array(buf));
      const off=hmac[hmac.length-1]&0xf;
      const code=((hmac[off]&0x7f)<<24)|((hmac[off+1]&0xff)<<16)|((hmac[off+2]&0xff)<<8)|(hmac[off+3]&0xff);
      return (code%10**digits).toString().padStart(digits,'0');
    }

    function parseOtpauth(url){
      try{
        const u=new URL(url);
        const params=Object.fromEntries(u.searchParams.entries());
        return {secret:params.secret,period:parseInt(params.period||'30',10),digits:parseInt(params.digits||'6',10)};
      }catch(e){return null;}
    }

    const codeEl=document.getElementById('code');
    const msg=document.getElementById('msg');

    function showMsg(){msg.classList.add('show');setTimeout(()=>msg.classList.remove('show'),800);}

    async function updateCode(){
      const otpData=JSON.parse(localStorage.getItem('otpdata'));
      if(!otpData)return;
      const c=await totp(otpData.secret,otpData.period,otpData.digits);
      codeEl.textContent=c;
    }

    async function init(){
      let otpData=localStorage.getItem('otpdata');
      if(!otpData){
        const url=prompt('Cole sua URL otpauth://');
        if(!url)return;
        const parsed=parseOtpauth(url);
        if(!parsed||!parsed.secret){alert('URL invÃ¡lida');return;}
        localStorage.setItem('otpdata',JSON.stringify(parsed));
      }
      await updateCode();
      setInterval(updateCode,1000);
    }

    document.body.addEventListener('click',()=>{
      const text=codeEl.textContent;
      navigator.clipboard.writeText(text).then(()=>showMsg());
    });

    init();
  </script></body>
  </html>
